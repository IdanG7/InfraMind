---
# Network Policies for securing InfraMind components
# Requires a CNI plugin that supports NetworkPolicy (Calico, Cilium, Weave, etc.)

# API can receive traffic from ingress and agents
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: inframind-api-netpol
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: inframind-api
      component: api
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    # Allow from ingress controller
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    # Allow from Prometheus (for metrics scraping)
    - podSelector:
        matchLabels:
          app: prometheus
    # Allow from other API pods (health checks)
    - podSelector:
        matchLabels:
          app: inframind-api
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
  egress:
  - to:
    # Allow to PostgreSQL
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    # Allow to Redis
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to:
    # Allow to MinIO
    - podSelector:
        matchLabels:
          app: minio
    ports:
    - protocol: TCP
      port: 9000
  - to:
    # Allow DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
  - to:
    # Allow HTTPS for external API calls (if needed)
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# PostgreSQL only accepts traffic from API
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    # Only from API pods
    - podSelector:
        matchLabels:
          app: inframind-api
    # Only from Prometheus (for metrics)
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 9187
  egress:
  - to:
    # Allow DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Redis only accepts traffic from API
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-netpol
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    # Only from API pods
    - podSelector:
        matchLabels:
          app: inframind-api
    # Only from Prometheus (for metrics)
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 9121
  egress:
  - to:
    # Allow DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Prometheus can scrape metrics from all components
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-netpol
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    # Allow from Grafana
    - podSelector:
        matchLabels:
          app: grafana
    # Allow from ingress (if exposing Prometheus)
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 9090
  egress:
  - to:
    # Scrape all pods in namespace
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 9102
    - protocol: TCP
      port: 9121
    - protocol: TCP
      port: 9187
  - to:
    # Allow DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Grafana can access Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-netpol
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    # Allow from ingress controller
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000
  egress:
  - to:
    # Allow to Prometheus
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
  - to:
    # Allow DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  - to:
    # Allow HTTPS for plugin downloads
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# Agent can send metrics to API (optional)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: inframind-agent-netpol
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: inframind-agent
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    # Allow from Prometheus (for metrics scraping)
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9102
  egress:
  - to:
    # Allow to API (optional, for sending data)
    - podSelector:
        matchLabels:
          app: inframind-api
    ports:
    - protocol: TCP
      port: 8080
  - to:
    # Allow DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 53
